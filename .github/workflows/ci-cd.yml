name: CI/CD for Docker

on:
  push:
    branches: [ "master" ]   # hoặc "master" nếu repo bạn dùng master

jobs:
  build:
    runs-on: [self-hosted, docker-build]

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify Docker login
        run: docker info

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/python_todolist:latest .

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/python_todolist:latest
        
  deploy:
  #deploy to render.com
  #  needs: build
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Trigger Render Deploy Hook
  #      run: |
  #        curl -X POST "${{ vars.RENDER_DEPLOY_HOOK }}"
  #   name: Deploy to Minikube
  #   needs: build
  #   runs-on: [self-hosted, minikube]   # Chạy trên runner có label minikube
  #   env:
 #      KUBECONFIG: /home/actions/.kube/config   # Bắt buộc trỏ đúng kubeconfig
  #   steps:
  #     - name: Checkout repo
    #     uses: actions/checkout@v3

     #  - name: Deploy latest image
     #    run: |
       #    kubectl get nodes
        #   kubectl get pods
        #  kubectl set image deployment/python-todolist python-todolist-d6h89=anhnguyen1988/python_todolist:latest
         #  kubectl rollout status deployment/python-todolist
  deploy:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    needs: build   # Chỉ chạy khi job build thành công

    steps:
      # 1. Cấu hình kubeconfig
      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          cp /home/actions/.kube/config ~/.kube/config
          export KUBECONFIG=~/.kube/config
          kubectl cluster-info

      # 2. Deploy lên Kubernetes
      - name: Update deployment image
        run: |
          export KUBECONFIG=~/.kube/config
          kubectl set image deployment/python-todolist python-todolist-d6h89=${{ secrets.DOCKERHUB_USERNAME }}/python_todolist:latest
          kubectl rollout status deployment/python-todolist